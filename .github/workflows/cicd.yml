# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
# https://github.com/actions

name: CICD

on:
  push:
    paths:
      - 'src/**'
    branches:
      - 'master'
      - 'release'
      - 'develop'
      - 'feature'
      - 'hotfix'
      - 'master/**'
      - 'release/**'
      - 'develop/**'
      - 'feature/**'
      - 'hotfix/**'
  repository_dispatch:
    types: 
      - builddispatch
  workflow_dispatch:

jobs:
  printJob:    
    name: Print event
    runs-on: ubuntu-latest
    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: |
        echo "$GITHUB_CONTEXT"

  build:

    runs-on: ubuntu-latest
    
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
    - name: Checkout
      if: github.event.pull_request.merged
      uses: actions/checkout@v4

    - name: Setup-dotnet
      if: github.event.pull_request.merged
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Diagnostic print enviroment vars
      if: github.event.pull_request.merged
      run: printenv

    - name: Display dotnet version
      if: github.event.pull_request.merged
      run: dotnet --version    

    - name: Display powershell core version
      if: github.event.pull_request.merged
      run: pwsh --version

    - name: Workflow Build/Deploy
      if: github.event.pull_request.merged
      run: .github/workflows/cicd_main.ps1 "${{ secrets.PAT }}" "${{ secrets.NUGET_PAT }}" "${{ secrets.NUGET_TEST_PAT }}"
      shell: pwsh 
